---
layout: post
title:  "聊天输入框键盘和表情的平滑切换"
date:   2019-8-29 16:35:00
categories: Android
tags: Source code
image:
  feature: GamerChat.png
  topPosition: -100px
bgContrast: dark
bgGradientOpacity: darker
syntaxHighlighter: no
---


### 问题

多数即时聊天软件避不开发表情，而Android app切换表情和键盘时，依赖于adjustResize就会出现输入框乱弹，*&%¥…的情况，做过的都懂得。此文章将介绍一个简单的方法，实现键盘和表情的平滑切换。

起初是因为呱聊输入框右侧需要承载的功能按钮较多，需要根据各种¥&*%**的条件，变更按钮的隐藏和展开状态（现已弃用），如图：

![image-20190829153233290](/tmp/image-20190829153233290.png)

![image-20190829153247283](/tmp/image-20190829153247283.png)

我尝试监听输入框当前的位置来实现，但是切换键盘、表情时，输入框就会上下弹动，无法作为判断依据。除此之外甚至键盘切换表情的时候存在更凄惨的情况：

![image-20190829153519026](/tmp/image-20190829153519026.png)



### 原因

键盘弹出和收起需要时间，依赖于adjustResize就会出现布局不稳定。

adjustResize：始终调整Activity主窗口的尺寸来为屏幕上的软键盘腾出空间。效果就是把Activity的布局压小了，显示在键盘上面。

+ 键盘收起需要时间，adjustResize就会在收起的时间里也预留高度，这个时候弹出表情栏的动作已经执行，所有就出现了上图的情况。
+ 键盘弹出也需要时间，收起表情栏的动作已经执行，它才慢悠悠的弹出来，adjustResize就使得输入框随着收起动作降到底部，再跟着键盘推上来



虽然最后通过另一种方式实现了按钮展开/隐藏这个需求的逻辑判断，但是对于一个即时聊天为主要功能的app来说，输入框的体验不好也不是个小问题，于是我尝试对此进行了优化。



### 解决办法

实现方法并不难，手动计算布局高度即可。

#### 参考demo

https://github.com/angcyo/ExKeyboardDemo

1. 自己写SwitchLayout继承ViewGroup，作为底层布局，两个子布局是emojiLayout和contentLayout
   + emojiLayout为表情栏
   + contentLayout是聊天消息列表

2. onMeasure中根据键盘/表情框状态，去计算消息列表和弹出框两个子布局的高度
   + 收起键盘，收起表情栏时，contentLayout占满布局，emojiLayout高度为0
   + 弹出键盘时，contentLayout高度=布局最大高度-键盘高度，emojiLayout高度为0（键盘的高度可以根据Screen的高度减去Window的高度获取）
   + 弹出表情栏时，contentLayout高度=布局最大高度-emojiLayout的高度，emojiLayout高度为设定值
3. 弹出表情框的时候收起键盘，调用requestLayout()计算布局

此方法也需要设为adjustResize



#### 核心代码

计算布局高度

```java
 @Override
    protected void onMeasure(int widthMeasureSpec, int heightMeasureSpec) {
        Log.d("SwitchLayout","onMeasure "+"keyboard "+isKeyboardShow+" emoji "+isEmojiShow);
        int widthSize = MeasureSpec.getSize(widthMeasureSpec);
        int heightSize = MeasureSpec.getSize(heightMeasureSpec);
        int maxHeight = heightSize - getPaddingBottom() - getPaddingTop();

        isKeyboardShow = isSoftKeyboardShow();
        if (isKeyboardShow) {
            keyboardHeight = getSoftKeyboardHeight();
            isEmojiShow = false;
        }

        int contentHeight;
        int emojiHeight;

        if (isEmojiShow) {
            if (getShowEmojiHeight() == 0) {
                emojiHeight = keyboardHeight;
            } else {
                emojiHeight = getShowEmojiHeight();
            }
        } else {
            emojiHeight = 0;
        }

        if (isKeyboardShow) {
            contentHeight = maxHeight;
        } else {
            contentHeight = maxHeight - emojiHeight;
        }

        contentLayout.measure(MeasureSpec.makeMeasureSpec(widthSize, MeasureSpec.EXACTLY),
                MeasureSpec.makeMeasureSpec(contentHeight, MeasureSpec.EXACTLY));
        emojiLayout.measure(MeasureSpec.makeMeasureSpec(widthSize, MeasureSpec.EXACTLY),
                MeasureSpec.makeMeasureSpec(emojiHeight, MeasureSpec.EXACTLY));
        setMeasuredDimension(widthSize, heightSize);
    }
```

弹出表情/收起表情

```java
private void showEmojiLayoutInner(int height) {
        if (isEmojiShow && height == showEmojiHeight) {
            return;
        }

        boolean keyboardShow = isKeyboardShow();
        int oldHeight = showEmojiHeight;

        isEmojiShow = height > 0;
        this.showEmojiHeight = height;

        if (keyboardShow) {
            hideSoftInput();
        } else {
            requestLayout();
            if (isAnimToShow) {
                animToShow(height, oldHeight);
            } else {
                post(mCheckSizeChanged);
            }
        }
    }
```

获取键盘高度

```java
  public int getSoftKeyboardHeight() {
        int screenHeight = getResources().getDisplayMetrics().heightPixels;
        Rect rect = new Rect();
        getWindowVisibleDisplayFrame(rect);
        int visibleBottom = rect.bottom;
        return screenHeight - visibleBottom;
    }
```



#### 原代码存在的小问题

1. 如果设置为无动画效果时，布局比较复杂的时候就不能做到键盘切换表情，表情会弹不出来。

   原因如下，onMeasure中

   ```java
     isKeyboardShow = isSoftKeyboardShow();
           if (isKeyboardShow) {
               keyboardHeight = getSoftKeyboardHeight();
               isEmojiShow = false;
           }
   
   ```

   showEmojiLayoutInner里会调用requestLayout，就会触发布局的重新计算，第一次计算是正常的。但是如果布局相对复杂，onMeasure就会被调用多次来计算布局，短时间内紧接着的第二次计算就会因为键盘没来得及收回去从而把 isEmojiShow置为false。

   所以我增加一个标志位表示现在正在尝试弹出表情，不应该被收起。

   ```java
    isKeyboardShow = isSoftKeyboardShow()
           if (isKeyboardShow) {
               keyboardHeight = getSoftKeyboardHeight()
               if (!tryShowEmoticons)
                   isEmojiShow = false
           } else {
               if (tryShowEmoji)
                   tryShowEmoji = false
           }
   ```

   在showEmoticonsLayoutInner里设为true

   ```java
   private fun showEmoticonsLayoutInner(height: Int) {
           tryShowEmoticons = true
   ```

   如果大家使用这个demo的代码，遇到表情弹不出来的情况可以参考我的思路加标志位。

2. animToShow(height, oldHeight)中oldHeight的高度

   原代码

   ```java
   int oldHeight = showEmojiHeight;
   ```

   修改为

   ```kotlin
   val oldHeight = if (keyboardShow) keyboardHeight else showEmoticonsHeight
   ```

   否则有时候动画会是反向的



### 总结

通过继承ViewGroup自行计算子布局信息列表和表情栏的高度，就可以实现键盘、表情的平滑切换。github有很多不错的参考代码，但也不能完全搬来即用，要根据实际效果、实际需求，去使用和优化这些开源代码。

